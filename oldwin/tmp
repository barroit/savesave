	if (!dotsav_path)
		dotsav_path = get_dotsav_defpath();
	if (!dotsav_path)
		die(_("no dotsav (.savesave) was provided"));

	struct savesave *savv;
	size_t savc = parse_dotsav(dotsav_path, &savv);
	if (!savc)
		die(_("dotsav `%s' must contain at least one configuration"),
		    dotsav_path);
	DEBUG_RUN()
		print_dotsav(savv, savc);

	backup(savv);
	exit(0);



// SPDX-License-Identifier: GPL-3.0-only
/*
 * Copyright 2024 Jiamu Sun
 *
 * Contact: barroit@linux.com
 */

#include "win/console.hpp"
#include "win/ui.hpp"
#include "termas.h"
#include "robio.h"
#include "win/cmdline.hpp"
#include "win/backup.hpp"
#include "dotsav.h"
#include "debug.h"
#include "win/atenter.hpp"
#include "strlist.h"

static class console appcon;
static struct savesave *dotsav;

#ifdef CONFIG_IS_CONSOLE_APP
int main(int argc, char **argv)
#else
int WINAPI WinMain(HINSTANCE app, HINSTANCE, char *cmdline, int)
#endif
{
	/*
	 * class constructor is guaranteed to run before main function, use
	 * that for constructor function leak support on windows
	 */
	static class atenter constructor;

#ifndef CONFIG_IS_CONSOLE_APP
	appcon.setup_console();
#endif
	setup_console_codepage();
	setup_message_translation();

	constructor.precheck();

#ifndef CONFIG_IS_CONSOLE_APP
	char **argv;
	int argc = cmdline2argv(cmdline, &argv);
#endif

#ifndef CONFIG_IS_CONSOLE_APP
	destroy_dumped_strlist(argv);
#endif


#ifdef CONFIG_IS_CONSOLE_APP
	exit(0); /* TODO LATER IMPL */
#else
	int err;
	HWND window;

	err = create_app_window(app, &window);
	if (err)
		die(_("unable to initialize main window"));

	NOTIFYICONDATA icon;
	setup_notifyicon(app, window, &icon);
	show_notifyicon(&icon);

	MSG message;
	while (GetMessage(&message, NULL, 0, 0) > 0) {
		TranslateMessage(&message);
		DispatchMessage(&message);
	}

	exit(0);
#endif /* CONFIG_IS_CONSOLE_APP */
}

class console *get_app_console()
{
	return &appcon;
}
